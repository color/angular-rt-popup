angular.module("rt.popup",[]).factory("Popup",["$window","$document","$timeout","$compile","$parse",function(a,b,c,d,e){function f(a){m&&!$.contains(m.el[0],a.target)&&g()}function g(){if(m){var a=m;m=null,c(function(){e(a.options.popupHidden)(a.scope),a.el.removeClass(a.options.popupShowClass),a.options.popupCloseTimeout?c(function(){a.el.hide().remove()},a.options.popupCloseTimeout):a.el.hide().remove(),b.off("click",f)})}}function h(a,b){for(var c in b)a[c]||(a[c]=b[c])}function i(a,b,d){h(d,{popupPlacement:"right",popupClass:"",popupShown:"",popupHidden:"",popupShowClass:"js--active",popupCloseTimeout:300,popupArrowYOffset:18,popupOverlap:5}),b.popupView=d.popupShow,b.hidePopover=g,c(function(){l(a,b,d)})}function j(c){var d=c[0].getBoundingClientRect();return{width:d.width||c.prop("offsetWidth"),height:d.height||c.prop("offsetHeight"),top:d.top+(a.pageYOffset||b[0].documentElement.scrollTop),left:d.left+(a.pageXOffset||b[0].documentElement.scrollLeft)}}function k(c,d,g,h,i){var k=null,l=null,m=null,n=j(d),p=i.popupPlacement,q=i.popupClass,r=a.innerHeight-2*o,s=i.popupArrowYOffset,t=parseFloat(i.popupOverlap);if("right"===p)m={top:n.top+n.height/2,left:n.left+n.width-t},k={top:m.top-g.height()/2,left:m.left},k.top=Math.max(o,k.top),l={top:m.top-k.top};else if("left"===p)m={top:n.top+n.height/2,left:n.left+t-2},k={top:m.top-g.height()/2,left:m.left-g.width()},k.top=Math.max(o,k.top),l={top:m.top-k.top};else if("bottom"===p)m={top:n.top+n.height,left:n.left+n.width/2},k={top:m.top-t,left:m.left-g.width()/2},k.left=Math.max(o,k.left),r-=k.top,l={left:m.left-k.left};else if("top"===p)m={top:n.top-g.outerHeight(),left:n.left+n.width/2},k={top:m.top+t,left:m.left-g.width()/2},k.left=Math.max(o,k.left),r-=k.top,l={left:m.left-k.left};else if("top-right"===p)m={top:n.top+n.height/2,left:n.left+n.width-t},k={top:m.top-s,left:m.left},k.top=Math.max(o,k.top),l={top:m.top-k.top};else{if("top-left"!==p)throw new Error("Unsupported placement "+p);console.log(n.width),console.log(t),m={top:n.top+n.height/2,left:n.left+t-2},console.log(m.left),k={top:m.top-s,left:m.left-g.width()},k.top=Math.max(o,k.top),l={top:m.top-k.top}}g.removeClass("left right bottom top"),g.addClass(p),q&&g.addClass(q),g.css({top:k.top+"px",left:k.left+"px",display:"block",maxHeight:r});var u=g.find(".popover-title"),v=g.find(".popover-content"),w=g.find(".popover-footer");v.css({maxHeight:r-w.outerHeight()-u.outerHeight()-4,overflow:"auto"}),l&&h.css(l),g.removeClass("hide"),g.addClass(i.popupShowClass),b.on("click",f),e(i.popupShown)(c)}function l(a,e,f){var g=d(n)(e);m={el:g,options:f,scope:e};var h=b.find("body");h.append(g);var i=$("<div />",{"class":"arrow"});g.children(".arrow").remove(),g.append(i),e.$reposition=function(){c(function(){k(e,a,g,i,f)})}}var m=null,n='<div class="popover"><div ng-include="popupView" onload="$reposition()"></div></div>',o=10;return{show:i,close:g}}]).directive("popupShow",["Popup","$parse",function(a,b){return{restrict:"A",scope:!0,link:function(c,d,e){d.bind("click",function(f){f.stopPropagation(),a.close();var g=b(e.popupIf||"true");g(c)&&a.show(d,c,e)})}}}]).directive("popupAutoShow",["Popup","$parse",function(a,b){return{restrict:"A",link:function(c,d,e){c.$watch(e.popupAutoShow,function(f){if(f){a.close();var g=b(e.popupIf||"true");g(c)&&a.show(d,c,e)}})}}}]);